<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>âœ¨ ì•„ì´ëŒ ì¸ìƒë„¤ì»·</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&family=Bebas+Neue&display=swap');

  :root {
    --pink: #FF2D78;
    --pink-light: #FF82B2;
    --purple: #7B2FBE;
    --dark: #0D0D1A;
    --card: #16162A;
    --border: rgba(255,45,120,0.3);
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

  body {
    background: var(--dark);
    color: #fff;
    font-family: 'Noto Sans KR', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
  }

  body::before {
    content:''; position:fixed; top:-200px; left:-200px;
    width:600px; height:600px;
    background:radial-gradient(circle,rgba(123,47,190,0.25) 0%,transparent 70%);
    pointer-events:none; z-index:0;
  }
  body::after {
    content:''; position:fixed; bottom:-200px; right:-200px;
    width:600px; height:600px;
    background:radial-gradient(circle,rgba(255,45,120,0.2) 0%,transparent 70%);
    pointer-events:none; z-index:0;
  }

  header {
    text-align:center;
    padding:24px 16px 12px;
    position:relative; z-index:10;
  }

  .logo {
    font-family:'Bebas Neue',sans-serif;
    font-size:clamp(2rem,5vw,3rem);
    letter-spacing:4px;
    background:linear-gradient(135deg,var(--pink),var(--purple));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }

  .subtitle {
    font-size:clamp(0.7rem,1.5vw,0.85rem);
    color:rgba(255,255,255,0.5);
    margin-top:4px;
    letter-spacing:2px;
  }

  /* ë¸Œë¼ìš°ì € ì•ˆë‚´ ë°°ë„ˆ */
  .browser-banner {
    margin: 0 20px 12px;
    padding: 10px 16px;
    background: rgba(255,165,0,0.15);
    border: 1px solid rgba(255,165,0,0.4);
    border-radius: 10px;
    font-size: 0.78rem;
    color: rgba(255,220,100,0.9);
    text-align: center;
    display: none;
    position: relative;
    z-index: 10;
  }

  .main-layout {
    display:flex;
    gap:20px;
    padding:12px 20px 24px;
    max-width:1200px;
    margin:0 auto;
    align-items:flex-start;
    position:relative; z-index:10;
  }

  @media (max-width:800px) {
    .main-layout { flex-direction:column; }
    .side-panel { width:100% !important; flex-direction:row; flex-wrap:wrap; gap:12px; }
    .panel-card { flex:1; min-width:200px; }
    .shoot-btn-wrapper { width:100%; }
  }

  /* ì¹´ë©”ë¼ */
  .camera-section { flex:1; position:relative; }

  .camera-wrapper {
    position:relative;
    border-radius:20px;
    overflow:hidden;
    border:2px solid var(--border);
    box-shadow:0 0 40px rgba(255,45,120,0.15);
    background:#000;
    width:100%;
    aspect-ratio:4/3;
  }

  #video {
    width:100%; height:100%;
    object-fit:cover;
    transform:scaleX(-1);
    -webkit-transform:scaleX(-1);
    display:none;
  }

  #poseCanvas {
    position:absolute; top:0; left:0;
    width:100%; height:100%;
    pointer-events:none;
    transform:scaleX(-1);
    -webkit-transform:scaleX(-1);
  }

  .score-bar-wrapper {
    position:absolute; top:14px; left:14px; right:14px;
    z-index:20; display:none;
  }

  .score-label {
    font-size:0.7rem; font-weight:700; letter-spacing:1px;
    color:rgba(255,255,255,0.8); margin-bottom:5px;
    display:flex; justify-content:space-between;
  }

  .score-bar-bg {
    background:rgba(255,255,255,0.1);
    border-radius:10px; height:9px; overflow:hidden;
  }

  .score-bar-fill {
    height:100%; border-radius:10px;
    background:linear-gradient(90deg,var(--purple),var(--pink));
    width:0%; transition:width 0.3s ease;
  }

  .pose-feedback {
    position:absolute; bottom:14px; left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,0.75);
    -webkit-backdrop-filter:blur(10px);
    backdrop-filter:blur(10px);
    border-radius:50px; padding:10px 22px;
    font-size:clamp(0.72rem,1.5vw,0.88rem);
    font-weight:700; border:1px solid var(--border);
    white-space:nowrap; transition:all 0.3s;
    z-index:20; display:none;
  }

  .pose-feedback.matched {
    background:rgba(0,200,100,0.3);
    border-color:#00C864; color:#00ff88;
    animation:pulse-green 1s infinite;
  }

  @keyframes pulse-green {
    0%,100% { box-shadow:0 0 10px rgba(0,200,100,0.5); }
    50% { box-shadow:0 0 25px rgba(0,200,100,0.9); }
  }

  .countdown-display {
    position:absolute; top:50%; left:50%;
    transform:translate(-50%,-50%);
    font-family:'Bebas Neue',sans-serif;
    font-size:clamp(5rem,15vw,9rem);
    color:#fff;
    text-shadow:0 0 40px rgba(255,45,120,0.8);
    z-index:30; pointer-events:none;
    display:none;
  }

  @keyframes countdown-pop {
    0% { transform:translate(-50%,-50%) scale(1.5); opacity:0; }
    20% { transform:translate(-50%,-50%) scale(1); opacity:1; }
    80% { opacity:1; }
    100% { opacity:0; }
  }

  .flash {
    position:absolute; inset:0;
    background:#fff; opacity:0;
    pointer-events:none; z-index:40;
    border-radius:18px; transition:opacity 0.1s;
  }

  /* ì¹´ë©”ë¼ ì—†ì„ ë•Œ */
  .no-camera {
    width:100%; height:100%;
    display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    gap:14px; color:rgba(255,255,255,0.5);
    font-size:clamp(0.8rem,2vw,0.95rem);
    padding:20px; text-align:center;
  }

  .no-camera-icon { font-size:3rem; }

  .start-camera-btn {
    padding:16px 36px;
    background:linear-gradient(135deg,var(--pink),var(--purple));
    border:none; border-radius:50px;
    color:#fff; font-family:'Noto Sans KR',sans-serif;
    font-weight:700; cursor:pointer; font-size:1rem;
    min-height:52px; -webkit-appearance:none;
    box-shadow:0 4px 20px rgba(255,45,120,0.4);
    transition:all 0.2s;
  }

  .start-camera-btn:hover { transform:translateY(-2px); box-shadow:0 8px 30px rgba(255,45,120,0.5); }
  .start-camera-btn:active { transform:scale(0.97); }
  .start-camera-btn:disabled { opacity:0.5; cursor:not-allowed; transform:none; }

  /* ë¡œë”© */
  .loading-overlay {
    position:absolute; inset:0;
    background:rgba(13,13,26,0.9);
    display:none; flex-direction:column;
    align-items:center; justify-content:center;
    border-radius:18px; z-index:50; gap:14px;
  }

  .spinner {
    width:44px; height:44px;
    border:3px solid rgba(255,45,120,0.2);
    border-top-color:var(--pink);
    border-radius:50%;
    animation:spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform:rotate(360deg); } }
  .loading-text { font-size:0.82rem; color:rgba(255,255,255,0.7); font-weight:700; letter-spacing:1px; }

  /* ì‚¬ì´ë“œ íŒ¨ë„ */
  .side-panel {
    width:260px; display:flex;
    flex-direction:column; gap:14px;
  }

  .panel-card {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:16px; padding:16px;
  }

  .panel-title {
    font-size:0.72rem; font-weight:700;
    letter-spacing:2px; color:var(--pink);
    margin-bottom:12px; text-transform:uppercase;
  }

  .pose-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }

  .pose-btn {
    background:rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.1);
    border-radius:12px; padding:14px 8px;
    cursor:pointer; transition:all 0.2s;
    text-align:center; color:#fff;
    font-family:'Noto Sans KR',sans-serif;
    min-height:64px; -webkit-user-select:none; user-select:none;
  }

  .pose-btn:hover { border-color:var(--pink); background:rgba(255,45,120,0.1); }
  .pose-btn:active { transform:scale(0.95); }
  .pose-btn.active {
    border-color:var(--pink);
    background:rgba(255,45,120,0.2);
    box-shadow:0 0 12px rgba(255,45,120,0.3);
  }

  .pose-btn .emoji { font-size:1.7rem; display:block; margin-bottom:4px; }
  .pose-btn .pose-name { font-size:0.7rem; font-weight:700; }

  .frame-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }

  .frame-btn {
    aspect-ratio:3/4; border-radius:10px;
    cursor:pointer; border:2px solid transparent;
    transition:all 0.2s; background:rgba(255,255,255,0.05);
    display:flex; align-items:center; justify-content:center;
    flex-direction:column; gap:4px;
    -webkit-user-select:none; user-select:none; min-height:60px;
  }

  .frame-btn:hover { border-color:var(--pink-light); }
  .frame-btn:active { transform:scale(0.95); }
  .frame-btn.active { border-color:var(--pink); box-shadow:0 0 12px rgba(255,45,120,0.4); }
  .frame-btn .frame-icon { font-size:1.3rem; }
  .frame-btn .frame-label { font-size:0.58rem; color:rgba(255,255,255,0.7); font-weight:700; text-align:center; }
  .frame-btn.no-frame { font-size:0.62rem; color:rgba(255,255,255,0.5); font-weight:700; }

  .guide-box {
    background:rgba(123,47,190,0.15);
    border:1px solid rgba(123,47,190,0.4);
    border-radius:12px; padding:12px;
    font-size:0.76rem; line-height:1.7;
    color:rgba(255,255,255,0.85);
  }

  .guide-step { display:flex; align-items:flex-start; gap:8px; margin-bottom:7px; }
  .guide-step:last-child { margin-bottom:0; }

  .step-num {
    background:var(--pink); color:#fff;
    border-radius:50%; width:18px; height:18px;
    display:flex; align-items:center; justify-content:center;
    font-size:0.65rem; font-weight:900; flex-shrink:0; margin-top:2px;
  }

  .shoot-btn {
    width:100%; padding:18px;
    background:linear-gradient(135deg,var(--pink),var(--purple));
    border:none; border-radius:14px;
    color:#fff; font-family:'Noto Sans KR',sans-serif;
    font-size:clamp(0.9rem,2vw,1rem); font-weight:700;
    cursor:pointer; letter-spacing:1px;
    transition:all 0.15s;
    box-shadow:0 4px 20px rgba(255,45,120,0.4);
    -webkit-user-select:none; user-select:none;
    min-height:56px; -webkit-appearance:none;
  }

  .shoot-btn:hover { transform:translateY(-2px); box-shadow:0 8px 30px rgba(255,45,120,0.5); }
  .shoot-btn:active { transform:scale(0.97); }
  .shoot-btn:disabled { opacity:0.4; cursor:not-allowed; transform:none; }

  /* ê°¤ëŸ¬ë¦¬ */
  .gallery-section {
    max-width:1200px; margin:0 auto;
    padding:0 20px 48px;
    position:relative; z-index:10;
  }

  .gallery-title {
    font-family:'Bebas Neue',sans-serif;
    font-size:1.5rem; letter-spacing:3px;
    color:var(--pink); margin-bottom:14px;
  }

  .gallery-grid { display:flex; gap:12px; flex-wrap:wrap; }

  .gallery-item {
    position:relative;
    width:clamp(90px,18vw,130px);
    border-radius:12px; overflow:hidden;
    border:2px solid var(--border);
    cursor:pointer; transition:all 0.2s;
  }

  .gallery-item:hover { border-color:var(--pink); transform:translateY(-4px); box-shadow:0 8px 20px rgba(255,45,120,0.3); }
  .gallery-item:active { transform:scale(0.97); }
  .gallery-item img { width:100%; display:block; }

  .gallery-item .dl-label {
    background:linear-gradient(transparent,rgba(0,0,0,0.85));
    text-align:center; padding:12px 0 6px;
    font-size:0.65rem; color:#fff; font-weight:700;
    letter-spacing:1px; position:absolute;
    bottom:0; left:0; right:0;
    opacity:0; transition:opacity 0.2s;
  }

  .gallery-item:hover .dl-label { opacity:1; }
</style>
</head>
<body>

<!-- ë¸Œë¼ìš°ì € ì•ˆë‚´ -->
<div class="browser-banner" id="browserBanner"></div>

<header>
  <div class="logo">âœ¨ ì•„ì´ëŒ ì¸ìƒë„¤ì»·</div>
  <div class="subtitle">AI í¬ì¦ˆ ê°€ì´ë“œë¡œ ì•„ì´ëŒì´ë‘ ì°°ë–¡ ì»¤í”Œìƒ·</div>
</header>

<div class="main-layout">

  <div class="camera-section">
    <div class="camera-wrapper" id="cameraWrapper">

      <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">AI ëª¨ë¸ ë¡œë”© ì¤‘...</div>
      </div>

      <div class="no-camera" id="noCameraMsg">
        <div class="no-camera-icon">ğŸ“¸</div>
        <div>ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•´<br>ì•„ì´ëŒê³¼ í¬ì¦ˆë¥¼ ë§ì¶°ë³´ì„¸ìš”!</div>
        <button class="start-camera-btn" id="startBtn" onclick="startCamera()">ì¹´ë©”ë¼ ì‹œì‘í•˜ê¸°</button>
      </div>

      <video id="video" autoplay playsinline muted
             webkit-playsinline="true"></video>
      <canvas id="poseCanvas"></canvas>

      <div class="score-bar-wrapper" id="scoreBarWrapper">
        <div class="score-label">
          <span>í¬ì¦ˆ ë§¤ì¹­ë„</span>
          <span id="scorePct" style="color:var(--pink-light);font-weight:900;">0%</span>
        </div>
        <div class="score-bar-bg">
          <div class="score-bar-fill" id="scoreBarFill"></div>
        </div>
      </div>

      <div class="pose-feedback" id="poseFeedback">ğŸ“· í¬ì¦ˆë¥¼ ë§ì¶°ë³´ì„¸ìš”!</div>
      <div class="countdown-display" id="countdownDisplay"></div>
      <div class="flash" id="flash"></div>
    </div>
  </div>

  <div class="side-panel">
    <div class="panel-card">
      <div class="panel-title">ğŸ¯ í¬ì¦ˆ ì„ íƒ</div>
      <div class="pose-grid">
        <button class="pose-btn active" onclick="selectPose('heart')" id="pose-heart">
          <span class="emoji">ğŸ«¶</span><span class="pose-name">ì†ê°€ë½ í•˜íŠ¸</span>
        </button>
        <button class="pose-btn" onclick="selectPose('peace')" id="pose-peace">
          <span class="emoji">âœŒï¸</span><span class="pose-name">ë¸Œì´</span>
        </button>
        <button class="pose-btn" onclick="selectPose('thumbsup')" id="pose-thumbsup">
          <span class="emoji">ğŸ‘</span><span class="pose-name">ì—„ì§€ì²™</span>
        </button>
        <button class="pose-btn" onclick="selectPose('wave')" id="pose-wave">
          <span class="emoji">ğŸ‘‹</span><span class="pose-name">ì† í”ë“¤ê¸°</span>
        </button>
      </div>
    </div>

    <div class="panel-card">
      <div class="panel-title">ğŸ–¼ï¸ ì•„ì´ëŒ í”„ë ˆì„</div>
      <div class="frame-grid">
        <button class="frame-btn no-frame active" onclick="selectFrame('none')" id="frame-none">í”„ë ˆì„<br>ì—†ìŒ</button>
        <button class="frame-btn" onclick="selectFrame('kpop1')" id="frame-kpop1">
          <span class="frame-icon">ğŸ’œ</span><span class="frame-label">K-POP STAR</span>
        </button>
        <button class="frame-btn" onclick="selectFrame('kpop2')" id="frame-kpop2">
          <span class="frame-icon">ğŸŒ¸</span><span class="frame-label">IDOL PINK</span>
        </button>
        <button class="frame-btn" onclick="selectFrame('kpop3')" id="frame-kpop3">
          <span class="frame-icon">â­</span><span class="frame-label">STAR NIGHT</span>
        </button>
        <button class="frame-btn" onclick="selectFrame('kpop4')" id="frame-kpop4">
          <span class="frame-icon">ğŸ€</span><span class="frame-label">RIBBON</span>
        </button>
        <button class="frame-btn" onclick="selectFrame('kpop5')" id="frame-kpop5">
          <span class="frame-icon">ğŸ”¥</span><span class="frame-label">FIRE</span>
        </button>
      </div>
    </div>

    <div class="panel-card">
      <div class="panel-title">ğŸ’¡ ì´ìš© ë°©ë²•</div>
      <div class="guide-box">
        <div class="guide-step"><div class="step-num">1</div><div>ì¹´ë©”ë¼ ì‹œì‘ í›„ í¬ì¦ˆë¥¼ ì„ íƒí•˜ì„¸ìš”</div></div>
        <div class="guide-step"><div class="step-num">2</div><div>í™”ë©´ ê°€ì´ë“œë¥¼ ë”°ë¼ ì† í¬ì¦ˆë¥¼ ë§ì¶”ì„¸ìš”</div></div>
        <div class="guide-step"><div class="step-num">3</div><div>ë§¤ì¹­ë„ <b style="color:var(--pink)">80% ì´ìƒ</b>ì´ë©´ ìë™ ì´¬ì˜!</div></div>
        <div class="guide-step"><div class="step-num">4</div><div>ì‚¬ì§„ í´ë¦­í•˜ë©´ ë°”ë¡œ ì €ì¥ ğŸ“²</div></div>
      </div>
    </div>

    <button class="shoot-btn" id="shootBtn" onclick="manualShoot()" disabled>
      ğŸ“¸ ì§€ê¸ˆ ì´¬ì˜í•˜ê¸°
    </button>
  </div>
</div>

<div class="gallery-section" id="gallerySection" style="display:none;">
  <div class="gallery-title">PHOTO GALLERY</div>
  <div class="gallery-grid" id="galleryGrid"></div>
</div>

<script>
// â”€â”€ í™˜ê²½ ê°ì§€ â”€â”€
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
              (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
const isFirefox = /Firefox/.test(navigator.userAgent);

// ë¸Œë¼ìš°ì € ì•ˆë‚´ ë°°ë„ˆ
(function() {
  const banner = document.getElementById('browserBanner');
  if (isIOS && isSafari) {
    banner.textContent = 'ğŸ“± Safariì—ì„œ ì‹¤í–‰ ì¤‘ â€” ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”';
    banner.style.display = 'block';
  } else if (isFirefox) {
    banner.textContent = 'âš ï¸ Firefoxì—ì„œëŠ” ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆì–´ìš”. Chrome ì‚¬ìš©ì„ ê¶Œì¥í•´ìš”!';
    banner.style.display = 'block';
  }
})();

// â”€â”€ ìƒíƒœ â”€â”€
let currentPose = 'heart';
let currentFrame = 'none';
let matchScore = 0;
let autoShootTimer = null;
let isCountingDown = false;
let handsInstance = null;
let mediaPipeLoaded = false;

const poseGuides = {
  heart: 'ğŸ«¶ ì—„ì§€ì™€ ê²€ì§€ ëì„ ë§ë‹¿ê²Œ í•˜íŠ¸ë¥¼ ë§Œë“¤ì–´ìš”!',
  peace: 'âœŒï¸ ê²€ì§€Â·ì¤‘ì§€ë¥¼ Vìë¡œ í¼ì³ë³´ì„¸ìš”!',
  thumbsup: 'ğŸ‘ ì—„ì§€ì†ê°€ë½ì„ ìœ„ë¡œ!',
  wave: 'ğŸ‘‹ ì†ì„ í¼ì³ í”ë“œëŠ” í¬ì¦ˆ!',
};

const frameStyles = {
  kpop1: { color1:'#7B2FBE', color2:'#FF2D78', label:'K-POP STAR â­', emoji:'ğŸ’œ' },
  kpop2: { color1:'#FFB7C5', color2:'#FF69B4', label:'IDOL PINK ğŸŒ¸', emoji:'ğŸŒ¸' },
  kpop3: { color1:'#1A1A3E', color2:'#4169E1', label:'STAR NIGHT ğŸŒ™', emoji:'â­' },
  kpop4: { color1:'#FF1493', color2:'#FF69B4', label:'RIBBON ğŸ€', emoji:'ğŸ€' },
  kpop5: { color1:'#FF4500', color2:'#FF8C00', label:'FIRE ğŸ”¥', emoji:'ğŸ”¥' },
};

// â”€â”€ MediaPipe ë™ì  ë¡œë“œ â”€â”€
function loadScript(src) {
  return new Promise((resolve, reject) => {
    // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ìŠ¤í‚µ
    if (document.querySelector(`script[src="${src}"]`)) { resolve(); return; }
    const s = document.createElement('script');
    s.src = src;
    s.crossOrigin = 'anonymous';
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

async function loadMediaPipe() {
  // CDN ëª©ë¡ (ìš°ì„ ìˆœìœ„ ìˆœ)
  const cdnSets = [
    [
      'https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js',
      'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1640029074/camera_utils.js',
    ],
    [
      'https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js',
      'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js',
    ],
  ];

  for (const [handsUrl, camUrl] of cdnSets) {
    try {
      document.getElementById('loadingText').textContent = 'AI ëª¨ë¸ ë¡œë”© ì¤‘...';
      await loadScript(handsUrl);
      await loadScript(camUrl);
      if (window.Hands && window.Camera) {
        mediaPipeLoaded = true;
        return true;
      }
    } catch(e) {
      console.warn('CDN ì‹¤íŒ¨, ë‹¤ìŒ ì‹œë„:', e);
    }
  }
  return false;
}

// â”€â”€ ì¹´ë©”ë¼ ì‹œì‘ â”€â”€
async function startCamera() {
  const btn = document.getElementById('startBtn');
  const loadingOverlay = document.getElementById('loadingOverlay');

  btn.disabled = true;
  btn.textContent = 'ì¤€ë¹„ ì¤‘...';
  loadingOverlay.style.display = 'flex';
  document.getElementById('noCameraMsg').style.display = 'none';

  // MediaPipe ë¡œë“œ
  if (!mediaPipeLoaded) {
    const ok = await loadMediaPipe();
    if (!ok) {
      showError('AI ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê³  ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
      return;
    }
  }

  // ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­
  const constraints = {
    video: {
      facingMode: 'user',
      width: { ideal: isIOS ? 1280 : 1280 },
      height: { ideal: isIOS ? 960 : 720 },
    },
    audio: false,
  };

  try {
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    const video = document.getElementById('video');
    video.srcObject = stream;

    // iOS Safari ëŒ€ì‘: ëª…ì‹œì  play()
    try { await video.play(); } catch(e) { console.warn('play() ê²½ê³ :', e); }

    // ë¹„ë””ì˜¤ ë¡œë“œ ëŒ€ê¸°
    await new Promise(resolve => {
      if (video.readyState >= 2) { resolve(); return; }
      video.addEventListener('loadeddata', resolve, { once: true });
      setTimeout(resolve, 3000); // ìµœëŒ€ 3ì´ˆ ëŒ€ê¸°
    });

    video.style.display = 'block';
    loadingOverlay.style.display = 'none';
    document.getElementById('scoreBarWrapper').style.display = 'block';
    document.getElementById('poseFeedback').style.display = 'block';
    document.getElementById('shootBtn').disabled = false;

    initMediaPipe(video);

  } catch(e) {
    console.error('ì¹´ë©”ë¼ ì˜¤ë¥˜:', e);
    let msg = 'ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ì–´ìš”.\n\n';
    if (e.name === 'NotAllowedError') {
      if (isIOS) msg += 'ğŸ“± Safari ì„¤ì • â†’ ì´ ì›¹ì‚¬ì´íŠ¸ â†’ ì¹´ë©”ë¼ â†’ "í—ˆìš©"ìœ¼ë¡œ ë³€ê²½í•´ ì£¼ì„¸ìš”.';
      else msg += 'ğŸ–¥ï¸ ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ ì˜† ğŸ”’ ì•„ì´ì½˜ â†’ ì¹´ë©”ë¼ â†’ "í—ˆìš©"ìœ¼ë¡œ ë³€ê²½í•´ ì£¼ì„¸ìš”.';
    } else if (e.name === 'NotFoundError') {
      msg += 'ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”. ì¹´ë©”ë¼ê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.';
    } else {
      msg += e.message;
    }
    showError(msg);
  }
}

function showError(msg) {
  document.getElementById('loadingOverlay').style.display = 'none';
  document.getElementById('noCameraMsg').style.display = 'flex';
  const btn = document.getElementById('startBtn');
  btn.disabled = false;
  btn.textContent = 'ì¹´ë©”ë¼ ì‹œì‘í•˜ê¸°';
  alert(msg);
}

// â”€â”€ MediaPipe ì´ˆê¸°í™” â”€â”€
function initMediaPipe(video) {
  const canvas = document.getElementById('poseCanvas');

  handsInstance = new window.Hands({
    locateFile: (file) =>
      `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}`,
  });

  handsInstance.setOptions({
    maxNumHands: 2,
    modelComplexity: 1,
    minDetectionConfidence: 0.65,
    minTrackingConfidence: 0.5,
  });

  handsInstance.onResults((results) => {
    drawHandsAndScore(results, canvas, video);
  });

  // iOS Safari: rAF ë£¨í”„ ì‚¬ìš© / ê·¸ ì™¸: Camera ìœ í‹¸ ì‚¬ìš©
  if (isIOS && isSafari) {
    let running = true;
    async function loop() {
      if (!running) return;
      if (video.readyState >= 2 && handsInstance) {
        try { await handsInstance.send({ image: video }); } catch(e) {}
      }
      requestAnimationFrame(loop);
    }
    loop();
  } else {
    try {
      const cam = new window.Camera(video, {
        onFrame: async () => {
          if (handsInstance) await handsInstance.send({ image: video });
        },
        width: 1280,
        height: 720,
      });
      cam.start();
    } catch(e) {
      // Camera ìœ í‹¸ ì‹¤íŒ¨ ì‹œ rAF í´ë°±
      console.warn('Camera ìœ í‹¸ ì‹¤íŒ¨, rAF í´ë°±:', e);
      async function loop() {
        if (video.readyState >= 2 && handsInstance) {
          try { await handsInstance.send({ image: video }); } catch(e) {}
        }
        requestAnimationFrame(loop);
      }
      loop();
    }
  }
}

// â”€â”€ ì† ê·¸ë¦¬ê¸° + ì ìˆ˜ ê³„ì‚° â”€â”€
function drawHandsAndScore(results, canvas, video) {
  const ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth || 640;
  canvas.height = video.videoHeight || 480;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (!results.multiHandLandmarks || !results.multiHandLandmarks.length) {
    updateScore(0); updateFeedback(0, false); return;
  }

  const lm = results.multiHandLandmarks[0];
  drawLandmarks(ctx, lm, canvas.width, canvas.height);

  const score = calculatePoseScore(lm, currentPose);
  updateScore(score);
  updateFeedback(score, true);

  if (score >= 80 && !isCountingDown) startAutoShoot();
  else if (score < 60 && isCountingDown) cancelAutoShoot();
}

function drawLandmarks(ctx, lm, w, h) {
  const connections = [
    [0,1],[1,2],[2,3],[3,4],[0,5],[5,6],[6,7],[7,8],
    [5,9],[9,10],[10,11],[11,12],[9,13],[13,14],[14,15],[15,16],
    [13,17],[17,18],[18,19],[19,20],[0,17]
  ];

  ctx.strokeStyle = 'rgba(255,130,178,0.6)';
  ctx.lineWidth = 2;
  connections.forEach(([a,b]) => {
    ctx.beginPath();
    ctx.moveTo(lm[a].x*w, lm[a].y*h);
    ctx.lineTo(lm[b].x*w, lm[b].y*h);
    ctx.stroke();
  });

  lm.forEach((p, i) => {
    const isKey = i===4 || i===8;
    ctx.beginPath();
    ctx.arc(p.x*w, p.y*h, isKey ? 8 : 4, 0, Math.PI*2);
    ctx.fillStyle = isKey ? '#FF2D78' : 'rgba(255,200,220,0.9)';
    ctx.fill();
  });

  if (currentPose === 'heart') {
    const t=lm[4], ix=lm[8];
    const dist = Math.hypot((t.x-ix.x)*w, (t.y-ix.y)*h);
    const mx = ((t.x+ix.x)/2)*w, my = ((t.y+ix.y)/2)*h;
    ctx.beginPath();
    ctx.moveTo(t.x*w, t.y*h);
    ctx.lineTo(ix.x*w, ix.y*h);
    ctx.strokeStyle = dist<40 ? '#00ff88' : '#FF2D78';
    ctx.lineWidth = 3; ctx.stroke();
    ctx.fillStyle = dist<40 ? '#00ff88' : '#fff';
    ctx.font = `bold ${Math.round(w*0.025)}px sans-serif`;
    ctx.textAlign = 'center';
    ctx.fillText(dist<40 ? 'ğŸ’• HEART!' : `${Math.round(dist)}px`, mx, my-12);
    ctx.textAlign = 'left';
  }
}

function calculatePoseScore(lm, pose) {
  if (pose==='heart') {
    const d = Math.hypot(lm[4].x-lm[8].x, lm[4].y-lm[8].y);
    return Math.round(Math.max(0, Math.min(100, (1-d/0.08)*100)));
  }
  if (pose==='peace') {
    const c=[lm[8].y<lm[6].y, lm[12].y<lm[10].y, lm[16].y>lm[14].y, lm[20].y>lm[18].y].filter(Boolean).length;
    return Math.round((c/4)*100);
  }
  if (pose==='thumbsup') {
    const c=[lm[4].y<lm[5].y, lm[8].y>lm[6].y, lm[12].y>lm[10].y].filter(Boolean).length;
    return Math.round((c/3)*100);
  }
  if (pose==='wave') {
    const c=[[8,6],[12,10],[16,14],[20,18]].filter(([t,m])=>lm[t].y<lm[m].y).length;
    return Math.round((c/4)*100);
  }
  return 0;
}

function updateScore(score) {
  matchScore = score;
  document.getElementById('scoreBarFill').style.width = score+'%';
  document.getElementById('scorePct').textContent = score+'%';
  document.getElementById('scoreBarFill').style.background =
    score>=80 ? 'linear-gradient(90deg,#00C864,#00ff88)' :
    score>=50 ? 'linear-gradient(90deg,#FF8C00,#FFD700)' :
    'linear-gradient(90deg,var(--purple),var(--pink))';
}

function updateFeedback(score, hasHand) {
  const el = document.getElementById('poseFeedback');
  if (!hasHand) { el.className='pose-feedback'; el.textContent='âœ‹ ì†ì„ í™”ë©´ì— ë³´ì—¬ì£¼ì„¸ìš”!'; return; }
  if (score>=80) { el.className='pose-feedback matched'; el.textContent='ğŸ’š ì™„ë²½! ìë™ ì´¬ì˜ ì¤‘...'; }
  else if (score>=50) { el.className='pose-feedback'; el.textContent='ğŸ’› ê±°ì˜ ë‹¤ ëì–´ìš”! ì¡°ê¸ˆë§Œ ë”!'; }
  else { el.className='pose-feedback'; el.textContent=poseGuides[currentPose]; }
}

// â”€â”€ ìë™ ì´¬ì˜ â”€â”€
function startAutoShoot() {
  isCountingDown = true;
  let count = 3;
  const display = document.getElementById('countdownDisplay');
  display.style.display = 'block';

  function tick() {
    if (matchScore < 60) { cancelAutoShoot(); return; }
    if (count <= 0) {
      display.style.display = 'none';
      takePhoto(); isCountingDown = false; return;
    }
    display.textContent = count;
    display.style.animation = 'none';
    void display.offsetHeight;
    display.style.animation = 'countdown-pop 1s ease';
    count--;
    autoShootTimer = setTimeout(tick, 1000);
  }
  tick();
}

function cancelAutoShoot() {
  isCountingDown = false;
  clearTimeout(autoShootTimer);
  document.getElementById('countdownDisplay').style.display = 'none';
}

function manualShoot() { takePhoto(); }

// â”€â”€ ì‚¬ì§„ ì´¬ì˜ â”€â”€
function takePhoto() {
  const video = document.getElementById('video');
  if (!video.srcObject) return;

  const flash = document.getElementById('flash');
  flash.style.opacity = '1';
  setTimeout(() => { flash.style.opacity = '0'; }, 200);

  const fc = document.createElement('canvas');
  fc.width = video.videoWidth || 640;
  fc.height = video.videoHeight || 480;
  const ctx = fc.getContext('2d');

  // ì¢Œìš° ë°˜ì „
  ctx.save();
  ctx.translate(fc.width, 0);
  ctx.scale(-1, 1);
  ctx.drawImage(video, 0, 0, fc.width, fc.height);
  ctx.restore();

  if (currentFrame !== 'none') drawFrame(ctx, fc.width, fc.height, frameStyles[currentFrame]);

  addToGallery(fc.toDataURL('image/png'));
}

function drawFrame(ctx, w, h, style) {
  const bw = 40;
  const grad = ctx.createLinearGradient(0, 0, w, h);
  grad.addColorStop(0, style.color1);
  grad.addColorStop(1, style.color2);
  ctx.strokeStyle = grad; ctx.lineWidth = bw;
  ctx.strokeRect(bw/2, bw/2, w-bw, h-bw);
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, w, 42);
  ctx.fillRect(0, h-52, w, 52);
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 18px "Noto Sans KR",sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText(style.label, w/2, 28);
  ctx.font = 'bold 14px sans-serif';
  ctx.fillText('âœ¨ ì•„ì´ëŒ ì¸ìƒë„¤ì»·', w/2, h-18);
  ctx.textAlign = 'left';
  [[bw,bw],[w-bw,bw],[bw,h-bw],[w-bw,h-bw]].forEach(([cx,cy]) => {
    ctx.beginPath(); ctx.arc(cx,cy,13,0,Math.PI*2);
    ctx.fillStyle='#fff'; ctx.fill();
    ctx.font='12px sans-serif'; ctx.textAlign='center';
    ctx.fillText(style.emoji, cx, cy+4); ctx.textAlign='left';
  });
}

// â”€â”€ ê°¤ëŸ¬ë¦¬ ì €ì¥ â”€â”€
function addToGallery(dataUrl) {
  document.getElementById('gallerySection').style.display = 'block';
  const grid = document.getElementById('galleryGrid');

  const item = document.createElement('div');
  item.className = 'gallery-item';

  const img = document.createElement('img');
  img.src = dataUrl;

  const dlLabel = document.createElement('div');
  dlLabel.className = 'dl-label';
  dlLabel.textContent = isIOS ? 'ğŸ‘† ê¸¸ê²Œ ëˆŒëŸ¬ ì €ì¥' : 'ğŸ’¾ í´ë¦­í•˜ì—¬ ì €ì¥';

  item.appendChild(img);
  item.appendChild(dlLabel);

  item.onclick = () => {
    if (isIOS) {
      // iOS: ìƒˆ íƒ­ìœ¼ë¡œ ì—´ì–´ì„œ ê¸¸ê²Œ ëˆŒëŸ¬ ì €ì¥
      const w = window.open('', '_blank');
      w.document.write(`
        <html><body style="margin:0;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:16px">
        <img src="${dataUrl}" style="max-width:100%;max-height:85vh;border-radius:12px">
        <p style="color:#fff;font-family:sans-serif;font-size:14px;text-align:center">ì´ë¯¸ì§€ë¥¼ ê¸¸ê²Œ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš” ğŸ“²</p>
        </body></html>`);
    } else {
      // Chrome / ë°ìŠ¤í¬íƒ‘: ë°”ë¡œ ë‹¤ìš´ë¡œë“œ
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = `idol_lifecut_${Date.now()}.png`;
      a.click();
    }
  };

  grid.prepend(item);
}

function selectPose(pose) {
  currentPose = pose;
  document.querySelectorAll('.pose-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('pose-'+pose).classList.add('active');
  cancelAutoShoot();
}

function selectFrame(frame) {
  currentFrame = frame;
  document.querySelectorAll('.frame-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('frame-'+frame).classList.add('active');
}
</script>
</body>
</html>
